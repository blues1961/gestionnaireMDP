# Rotation des secrets (prod) sans perte de données

## 1) Préparer

```bash
cd /opt/apps/mdp
git pull
chmod +x scripts/rotate-secrets.sh
```

## 2) Vérifier le plan (dry-run)

```bash
./scripts/rotate-secrets.sh --env prod
```

Optionnel (afficher les valeurs générées, prudent):

```bash
./scripts/rotate-secrets.sh --env prod --show-values
```

## 3) Appliquer la rotation

```bash
./scripts/rotate-secrets.sh --env prod --apply
```

Ce que fait le script:
- backup DB (`backups/<slug>_db-prod-<timestamp>.sql.gz`)
- backup du fichier `.env.local` (`.env.local.bak.<timestamp>`)
- rotation `POSTGRES_PASSWORD` (ALTER ROLE en base)
- rotation `DJANGO_SECRET_KEY`
- maintien `ADMIN_PASSWORD` (par défaut)
- redémarrage backend + `manage.py check`

Pour aussi tourner le mot de passe admin (optionnel):

```bash
./scripts/rotate-secrets.sh --env prod --rotate-admin-password --apply
```

## 4) Vérifier après rotation

```bash
curl -i https://mdp.mon-site.ca/api/healthz/
curl -i -X OPTIONS https://mdp.mon-site.ca/api/secrets/
```

Puis mettre à jour le coffre des env:

```bash
make push-secret-single SECRET_ENV=prod
```

## 5) Impact attendu

- Aucun drop de DB (pas de perte de données).
- Sessions/JWT existants invalidés après rotation de `DJANGO_SECRET_KEY` (normal).
- Connexions actives peuvent être brièvement interrompues pendant le redémarrage backend.

## 6) Rollback rapide (si nécessaire)

```bash
# restaurer le .env local depuis le backup le plus récent
cp .env.local.bak.<timestamp> .env.local
chmod 600 .env.local

# redémarrer backend
docker compose --env-file .env.prod -f docker-compose.prod.yml up -d --no-deps --force-recreate backend
```

Pour un rollback DB complet, restaurer le dump SQL généré dans `backups/`.
