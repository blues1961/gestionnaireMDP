# Diagnostic route /api/secrets/ (à exécuter sur le serveur prod)

cd /opt/apps/mdp

cat <<'PY' | docker compose --env-file .env.prod -f docker-compose.prod.yml exec -T backend python manage.py shell
from django.urls import resolve, Resolver404
for p in ("/api/healthz/", "/api/secrets/"):
    try:
        m = resolve(p)
        print(p, "->", m.view_name)
    except Resolver404:
        print(p, "-> Resolver404")
PY

# Si /api/secrets/ => Resolver404, reconstruire le backend puis retester:
docker compose --env-file .env.prod -f docker-compose.prod.yml up -d --build --force-recreate backend
docker compose --env-file .env.prod -f docker-compose.prod.yml exec -T backend python manage.py migrate
curl -i -X OPTIONS https://mdp.mon-site.ca/api/secrets/

# Ensuite, sur ta machine de dev:
# make push-secret
